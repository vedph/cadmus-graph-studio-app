<form (submit)="save()">
  <mat-tab-group>
    <!-- METADATA -->
    <mat-tab label="metadata">
      <div class="form-row">
        <!-- name -->
        <mat-form-field>
          <mat-label>name</mat-label>
          <input matInput [formControl]="name" />
          <mat-error
            *ngIf="$any(name).errors?.required && (name.dirty || name.touched)"
            >name required</mat-error
          >
          <mat-error
            *ngIf="$any(name).errors?.maxLength && (name.dirty || name.touched)"
            >name too long</mat-error
          >
        </mat-form-field>

        <!-- sourceType -->
        <mat-form-field>
          <mat-label>source type</mat-label>
          <mat-select [formControl]="sourceType">
            <mat-option [value]="undefined">n/a</mat-option>
            <mat-option [value]="1">item</mat-option>
            <mat-option [value]="2">part</mat-option>
          </mat-select>
          <mat-error
            *ngIf="
              $any(sourceType).errors?.required &&
              (sourceType.dirty || sourceType.touched)
            "
            >source type required</mat-error
          >
        </mat-form-field>

        <!-- sid -->
        <mat-form-field>
          <mat-label>SID</mat-label>
          <input matInput [formControl]="sid" />
          <mat-error
            *ngIf="$any(sid).errors?.maxLength && (sid.dirty || sid.touched)"
            >SID too long</mat-error
          >
        </mat-form-field>
      </div>

      <div class="form-row">
        <!-- facetFilter -->
        <mat-form-field>
          <mat-label>facet filter</mat-label>
          <input matInput [formControl]="facetFilter" />
          <mat-error
            *ngIf="
              $any(facetFilter).errors?.maxLength &&
              (facetFilter.dirty || facetFilter.touched)
            "
            >facet filter too long</mat-error
          >
        </mat-form-field>

        <!-- groupFilter -->
        <mat-form-field>
          <mat-label>group filter</mat-label>
          <input matInput [formControl]="groupFilter" />
          <mat-error
            *ngIf="
              $any(groupFilter).errors?.maxLength &&
              (groupFilter.dirty || groupFilter.touched)
            "
            >group filter too long</mat-error
          >
        </mat-form-field>

        <!-- flagsFilter -->
        <mat-form-field class="nr-input">
          <mat-label>flags filter</mat-label>
          <input type="number" matInput [formControl]="flagsFilter" min="0" />
        </mat-form-field>
      </div>

      <div class="form-row">
        <!-- partTypeFilter -->
        <mat-form-field>
          <mat-label>part type filter</mat-label>
          <input matInput [formControl]="partTypeFilter" />
          <mat-error
            *ngIf="
              $any(partTypeFilter).errors?.maxLength &&
              (partTypeFilter.dirty || partTypeFilter.touched)
            "
            >part type filter too long</mat-error
          >
        </mat-form-field>

        <!-- partRoleFilter -->
        <mat-form-field>
          <mat-label>part role filter</mat-label>
          <input matInput [formControl]="partRoleFilter" />
          <mat-error
            *ngIf="
              $any(partRoleFilter).errors?.maxLength &&
              (partRoleFilter.dirty || partRoleFilter.touched)
            "
            >part role filter too long</mat-error
          >
        </mat-form-field>
      </div>

      <div>
        <!-- description -->
        <mat-form-field class="long-text">
          <mat-label>description</mat-label>
          <textarea rows="3" matInput [formControl]="description"></textarea>
          <mat-error
            *ngIf="
              $any(description).errors?.maxLength &&
              (description.dirty || description.touched)
            "
            >description too long</mat-error
          >
        </mat-form-field>
      </div>
    </mat-tab>

    <!-- INPUT -->
    <mat-tab label="input">
      <cadmus-jmes
        [expression]="source.value"
        (expressionChange)="onExpressionChange($event)"
      ></cadmus-jmes>
    </mat-tab>

    <!-- OUTPUT -->
    <mat-tab label="output">
      <cadmus-mapping-output-editor
        [output]="mapping?.output"
        (outputChange)="onOutputChange($event)"
      ></cadmus-mapping-output-editor>
    </mat-tab>

    <!-- TEST -->
    <mat-tab label="test">
      <cadmus-mapping-runner [mapping]="mapping"></cadmus-mapping-runner>
    </mat-tab>

    <!-- HELP -->
    <mat-tab label="help">
      <h2>Quick Help</h2>
      <p>
        See the
        <a
          rel="noopener"
          target="_blank"
          href="https://myrmex.github.io/overview/cadmus/dev/concepts/graph-mappings/"
          >full documentation</a
        >
        for more.
      </p>
      <h3>Mappings</h3>
      <ul>
        <li><strong>source type</strong>: here just item/part.</li>
        <li>
          <strong>source</strong>: the
          <a rel="noopener" target="_blank" href="https://jmespath.org/"
            >JMES path</a
          >
          expression defining input data.
        </li>
        <li><strong>SID</strong>: for root mappings only.</li>
        <li><strong>facet filter</strong></li>
        <li><strong>group filter</strong></li>
        <li>
          <strong>flags filter</strong>: numeric value representing flags bits.
          All the flags must be matched.
        </li>
        <li><strong>part type filter</strong></li>
        <li><strong>part role filter</strong></li>
        <li><strong>description</strong></li>
        <li>
          <strong>output</strong>:
          <ul>
            <li>
              <strong>nodes</strong>: nodes to emit (here
              <code>key uid label [tag]</code>, one per line);
            </li>
            <li>
              <strong>triples</strong>: triples to emit (here
              <code>S P O</code> or <code>S P "literal"</code>, one per line);
            </li>
            <li>
              <strong>metadata</strong>: metadata to consume within the mapping
              context (here <code>key=value</code>, one per line). Presets:
              <ul>
                <li><strong>item-id</strong>: item GUID.</li>
                <li>
                  <strong>item-eid</strong>: item EID (from metadata part).
                </li>
                <li><strong>part-id</strong>: part GUID.</li>
                <li><strong>group-id</strong>: item's group ID.</li>
                <li><strong>facet-id</strong>: item's facet ID.</li>
                <li><strong>flags</strong>: item's flags.</li>
                <li><strong>.</strong>: current leaf node in source JSON.</li>
                <li>
                  <strong>index</strong>: index of processed element from a
                  source array.
                </li>
              </ul>
            </li>
          </ul>
        </li>
        <li><strong>children</strong>: optional child mappings.</li>
      </ul>
      <h3>Templates</h3>
      <ul>
        <li><code>&lcub;@...&rcub;</code>: JMES expression.</li>
        <li><code>&lcub;?...&rcub;</code>: node key.</li>
        <li><code>&lcub;$...&rcub;</code>: metadata key.</li>
        <li>
          <code>&lcub;!...&rcub;</code>: macro. Currently the only macro is
          <code>_hdate(separator)</code>.
        </li>
      </ul>
    </mat-tab>
  </mat-tab-group>

  <!-- buttons -->
  <div class="form-row">
    <button type="button" mat-flat-button color="warn" (click)="cancel()">
      <mat-icon>cancel</mat-icon> close
    </button>
    <button
      type="submit"
      [disabled]="form.invalid"
      mat-flat-button
      color="primary"
    >
      <mat-icon>check_circle</mat-icon> save
    </button>
  </div>
</form>
